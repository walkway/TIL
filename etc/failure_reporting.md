# Failure Reporting

````
1. 앞으로 어떻게 하면 장애가 발생하지 않을까
2. 어떻게 빨리 감지할까
3. 장애 영향을 최소화하려면
4. 시스템이 자동 복구되게 할 수 있을까
````
## 처리 프로세스
### 장애 탐지
- 모니터링 도구 알람, 관계 부서, 사용자 보고 통해 탐지
- 시스템 지표, 비즈니스 지표
````
시스템 지표: CPU, Memory, latency, 5xx error count 등
비즈니스 지표: 가게 상세 진입률, 주문 추이 등
외부 연동 시스템 지표: 연동시스템 주문 전달 실패, 프랜차이즈 시스템 오류 등
````

### 장애 전파
- 발생 원인 파악 -> 관련 부서 장애 내용 전파
- 확인된 최소의 정보만 가지고 빠르게 공지, 초기에 모든 항목을 확인하고 기입 할 수 없고, 파악하는데 최소한 몇 분의 시간은 걸리기 때문
````
// example
장애 등급
장애 기간
고객이 받는 영향
논의 채널
장애 원인
조치 내용
````
- 장애 복구와 장애 전파를 분리 운영: 엔지니어들이 장애 복구에 집중, 유관부서에서는 조금 더 서비스에 포커스 된 내용 전달
- 장애 복구를 진행하고 있는 엔지니어가 장애 전파도 같이하게 되면 서비스의 영향도 보다는 시스템의 상태를 공유하는 경우가 많음 -> 정보 전달은 되었지만, 사용자 친화적인 정보가 아니므로 별도의 해석을 하거나, 거꾸로 다시 질문을 해야 하는 상황이 야기될 수 있음
````
엔지니어 버전
A 서버에 트래픽이 몰려 레이턴시가 높습니다. 스케일 아웃 진행 중이며 10분 정도 소요될 것으로 예상합니다.

기획자 버전
사용자가 급증하여 A 서비스 이용이 원활하지 않습니다. 전체적인 접속 속도가 늦으며 간헐적으로 페이지 접근이 되지 않을 수 있습니다. 서버 증설 진행 중이며 10분 후에 정상화 될 예정입니다.
````
- 현재 상태, 조치 예정 시간, 후속 대응

### 장애 해결
- 장애가 지속, 확산되지 않도록 막음
- 유사한 상황의 경험 확인
- 서비스 정상화는 원인 파악보다 우선
````
롤백: pull request label을 붙이는 가이드 / 가장 먼저 장애 발생 직전 시점에 변경된 내용이 있는지 확인
서버 재기동
장비 증설
핫픽스 배포
````

### 장애 보고
````
요약: 장애 상황에 대해 간략히 설명한다.
장애 탐지 시간: 장애가 최초 탐지된 시간을 명시한다.
영향받은 서비스: 장애에 영향받은 서비스를 명시한다.
장애 원인: 장애가 발생한 원인을 설명한다.
타임라인과 해결 과정: 장애가 최초 발생한 시점부터 주요 진행 과정을 순서대로 설명한다. 어떻게 대응했는지 자세한 설명을 덧붙인다.
해결 과정과 예방책: 장애를 어떻게 해결했는지, 어떤 예방 조치를 취해야 하는지 자세하게 설명한다. Jira 티켓 정보도 포함한다.
관련 문서 및 추가 정보(선택 사항): 필요하면 기타 정보를 추가한다.
````

### 회고, 재발 방지
- 원인 분석 및 향후 대응책을 논의: 발생한 사건들을 나열 x, 시나리오를 만든다는 느낌으로 작성
- 장애 원인을 정확하게 찾기 위해서 5whys
  - 5whys는 도요타의 Taiichi Ohno가 체계적인 문제 해결을 위해 개발한 도구로, 어떠한 문제 상황에 대해 그러한 상황이 발생하게 된 원인을 ‘왜 그러한 상황이 발생하였는가?’ 라는 질문을 여러 번 반복해나가면 문제의 근본 원인에 도달할 수 있다는 방법론
- 장애가 발생하지 않도록 막는 방법(preventing future outages)
  - 해당 문제를 사전에 체크할 수 있도록 유닛 테스트, 통합(integration) 테스트 추가
  - 같은 문제가 발생하지 않도록 장기적으로 구조 개선
  - fast failure를 통해 리소스가 낭비되는 것을 막음(예: 연결(connection)에 실패하면 기다리지 말고 빠르게 실패로 처리)
- 장애 탐지를 개선하는 방법(improving outage detection)
  - 알람 시스템에 알람 항목 추가(예: request failure count > 1000)
  - 로그 추가
  - 여러 가지 수치를 한 번에 볼 수 있는 대시보드 만들기
- 장애 처리를 개선하는 방법(improving outage handling)
  - 작업 사전 공유
- 짧은 기간에 대응 가능한 것, 오랜 기간에 걸쳐서 대응해야 하는 것으로 나누기
- 사람 손이 덜 가는 방향, 실천 가능하면서 명확한 항목
  - ‘코드 리뷰를 더 꼼꼼히 하자’보다는 ‘코드 리뷰할 때 테스트 케이스가 추가되어 있는지 확인하는 체크리스트를 PR 템플릿에 추가한다’처럼 실천 가능한 액션 아이템

### 예방
- 모의 장애 훈련
- 아키텍처 리뷰, 각 서비스의 아키텍처를 모두 문서화해야 하고, 아키텍처를 설계하면서 반드시 지켜져야 할 핵심 내용을 사전에 정의하는 작업이 필요
- 공지, 문서화
- 인식 개선, 장애의 원인이 사람에게 향하면, 폐쇄적으로 이슈를 감추게 된다. 장애의 책임을 개인이나 특정 조직에 전가하지 않는다

https://engineering.linecorp.com/ko/blog/line-failure-reporting-and-follow-up-process-culture/
https://techblog.woowahan.com/2716/